import { useEffect, useState } from 'react';
import { MapContainer, TileLayer, WMSTileLayer, Marker, Popup, LayersControl, useMap, GeoJSON, ScaleControl } from 'react-leaflet';
import { GeoSearchControl, OpenStreetMapProvider } from 'leaflet-geosearch';
import 'leaflet/dist/leaflet.css';
import 'leaflet-geosearch/dist/geosearch.css';
import L from 'leaflet';
import './MapComponent.css';

// Fix for default marker icon issue in React-Leaflet
import markerIcon2x from 'leaflet/dist/images/marker-icon-2x.png';
import markerIcon from 'leaflet/dist/images/marker-icon.png';
import markerShadow from 'leaflet/dist/images/marker-shadow.png';

delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconUrl: markerIcon,
  iconRetinaUrl: markerIcon2x,
  shadowUrl: markerShadow,
});

// Tegnforklaring komponent
function LegendControl() {
  const map = useMap();
  const [showLegend, setShowLegend] = useState(true);

  useEffect(() => {
    const legend = L.control({ position: 'bottomleft' });

    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend-control');
      div.innerHTML = `
        <div class="legend-header">
          <h4>Tegnforklaring</h4>
          <button id="toggle-legend">‚àí</button>
        </div>
        <div class="legend-content" id="legend-content">
          <div class="legend-section">
            <h5>Arealbruk</h5>
            <div class="legend-item"><div class="legend-color" style="background: #FF6B6B;"></div> Boligomr√•der</div>
            <div class="legend-item"><div class="legend-color" style="background: #FF4757;"></div> Sentrumsomr√•der</div>
            <div class="legend-item"><div class="legend-color" style="background: #5F27CD;"></div> Industri</div>
            <div class="legend-item"><div class="legend-color" style="background: #FFA502;"></div> Kontor/N√¶ring</div>
            <div class="legend-item"><div class="legend-color" style="background: #FF3838;"></div> Handel</div>
            <div class="legend-item"><div class="legend-color" style="background: #2ED573;"></div> Gr√∏nnstruktur</div>
            <div class="legend-item"><div class="legend-color" style="background: #7BED9F;"></div> Landbruk</div>
            <div class="legend-item"><div class="legend-color" style="background: #006633;"></div> Skog</div>
            <div class="legend-item"><div class="legend-color" style="background: #3742FA;"></div> Vann</div>
            <div class="legend-item"><div class="legend-color" style="background: #747d8c;"></div> Transport</div>
          </div>
          <div class="legend-section">
            <h5>Infrastruktur</h5>
            <div class="legend-item"><div class="legend-line" style="background: #000;"></div> Riksveier</div>
            <div class="legend-item"><div class="legend-line" style="background: #555;"></div> Fylkesveier</div>
            <div class="legend-item"><div class="legend-line" style="background: #888;"></div> Kommunale veier</div>
            <div class="legend-item"><div class="legend-symbol">‚ö°</div> Kraftlinjer</div>
          </div>
        </div>
      `;

      // Toggle funksjonalitet
      const toggleBtn = div.querySelector('#toggle-legend');
      const content = div.querySelector('#legend-content');
      
      toggleBtn.addEventListener('click', () => {
        if (content.style.display === 'none') {
          content.style.display = 'block';
          toggleBtn.textContent = '‚àí';
        } else {
          content.style.display = 'none';
          toggleBtn.textContent = '+';
        }
      });

      return div;
    };

    map.addControl(legend);

    return () => map.removeControl(legend);
  }, [map]);

  return null;
}

// Kart-klikk handler
function MapClickHandler({ onLocationSelect }) {
  const map = useMap();

  useEffect(() => {
    const handleMapClick = async (e) => {
      const { lat, lng } = e.latlng;
      
      // Hent adresse-informasjon fra koordinater (reverse geocoding)
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1&accept-language=no`
        );
        const data = await response.json();
        
        if (data && data.address) {
          const locationInfo = {
            coordinates: { lat, lng },
            address: data.display_name,
            details: data.address,
            municipality: data.address.municipality || data.address.county || 'Ukjent kommune',
            postcode: data.address.postcode || 'Ukjent postnummer'
          };
          
          onLocationSelect(locationInfo);
        }
      } catch (error) {
        console.error('Feil ved henting av adresse:', error);
      }
    };

    map.on('click', handleMapClick);
    
    return () => {
      map.off('click', handleMapClick);
    };
  }, [map, onLocationSelect]);

  return null;
}

// S√∏kekomponent
function SearchField() {
  const map = useMap();

  useEffect(() => {
    const provider = new OpenStreetMapProvider({
      params: {
        countrycodes: 'no', // Begrens s√∏k til Norge
        'accept-language': 'no',
      },
    });

    const searchControl = new GeoSearchControl({
      provider,
      style: 'bar',
      position: 'topleft',
      showMarker: true,
      showPopup: true,
      marker: {
        icon: new L.Icon.Default(),
        draggable: false,
      },
      popupFormat: ({ query, result }) => result.label,
      maxMarkers: 1,
      retainZoomLevel: false,
      animateZoom: true,
      autoClose: true,
      searchLabel: 'S√∏k etter adresse eller sted...',
      keepResult: true,
    });

    map.addControl(searchControl);

    return () => map.removeControl(searchControl);
  }, [map]);

  return null;
}

const MapComponent = () => {
  // Kristiansand sentrum koordinater
  const center = [58.1599, 8.0182];
  const [markers, setMarkers] = useState([]);
  const [showArealbruk, setShowArealbruk] = useState(true);
  const [showKommunegrenser, setShowKommunegrenser] = useState(true);
  const [selectedLocation, setSelectedLocation] = useState(null);
  const [showSidepanel, setShowSidepanel] = useState(false);

  const { BaseLayer, Overlay } = LayersControl;

  // Arealbruk farger basert p√• plantyper
  const arealbrukStyles = {
    bolig: { color: '#FF6B6B', fillColor: '#FF6B6B', fillOpacity: 0.7 },
    sentrum: { color: '#FF4757', fillColor: '#FF4757', fillOpacity: 0.8 },
    industri: { color: '#5F27CD', fillColor: '#5F27CD', fillOpacity: 0.7 },
    kontor: { color: '#FFA502', fillColor: '#FFA502', fillOpacity: 0.7 },
    handel: { color: '#FF3838', fillColor: '#FF3838', fillOpacity: 0.8 },
    gronnstruktur: { color: '#2ED573', fillColor: '#2ED573', fillOpacity: 0.8 },
    landbruk: { color: '#7BED9F', fillColor: '#7BED9F', fillOpacity: 0.6 },
    skog: { color: '#006633', fillColor: '#006633', fillOpacity: 0.7 },
    vann: { color: '#3742FA', fillColor: '#3742FA', fillOpacity: 0.9 },
    transport: { color: '#747d8c', fillColor: '#747d8c', fillOpacity: 0.8 },
    teknisk: { color: '#A4B0BE', fillColor: '#A4B0BE', fillOpacity: 0.7 },
    friluft: { color: '#70A1FF', fillColor: '#70A1FF', fillOpacity: 0.6 },
    default: { color: '#DDD2FE', fillColor: '#DDD2FE', fillOpacity: 0.5 }
  };

  // Funksjon for √• √•pne PDF-filer
  const openPlanDocument = (documentType) => {
    const planId = selectedLocation ? `PL-2023-${Math.floor(Math.random() * 9999)}` : 'demo';
    
    // I en ekte implementasjon ville disse URL-ene peke til faktiske PDF-filer
    const documentUrls = {
      plankart: `https://www.kristiansand.kommune.no/plans/${planId}/plankart.pdf`,
      bestemmelser: `https://www.kristiansand.kommune.no/plans/${planId}/bestemmelser.pdf`,
      planbeskrivelse: `https://www.kristiansand.kommune.no/plans/${planId}/planbeskrivelse.pdf`
    };
    
    // For demo-form√•l viser vi en alert
    alert(`√Öpner ${documentType} for plan-ID: ${planId}\\n\\nI en ekte implementasjon ville dette √•pne:\\n${documentUrls[documentType]}`);
  };

  // Funksjon for √• bestemme stil basert p√• arealbruk
    const arealbruk = feature.properties?.arealbruk?.toLowerCase() || 'default';
    return arealbrukStyles[arealbruk] || arealbrukStyles.default;
  };

  // Popup innhold for arealbruk
  const onEachFeature = (feature, layer) => {
    if (feature.properties) {
      const props = feature.properties;
      layer.bindPopup(`
        <div>
          <h4>${props.navn || 'Ukjent omr√•de'}</h4>
          <p><strong>Arealbruk:</strong> ${props.arealbruk || 'Ikke spesifisert'}</p>
          <p><strong>Plantype:</strong> ${props.plantype || 'Ikke spesifisert'}</p>
          ${props.areal ? `<p><strong>Areal:</strong> ${props.areal} m¬≤</p>` : ''}
          ${props.utnyttingsgrad ? `<p><strong>Utnyttingsgrad:</strong> ${props.utnyttingsgrad}</p>` : ''}
        </div>
      `);
    }
  };

  return (
    <div className="map-container">
      <MapContainer 
        center={center} 
        zoom={13} 
        style={{ height: '100vh', width: showSidepanel ? '70vw' : '100vw' }}
        zoomControl={true}
        attributionControl={true}
      >
        <SearchField />
        <LegendControl />
        <MapClickHandler onLocationSelect={(location) => {
          setSelectedLocation(location);
          setShowSidepanel(true);
        }} />
        <ScaleControl position="bottomright" />
        
        <LayersControl position="topright">
          {/* Basiskart lag */}
          <BaseLayer checked name="OpenStreetMap">
            <TileLayer
              attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
              url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
            />
          </BaseLayer>

          <BaseLayer name="Satellitt (Esri)">
            <TileLayer
              attribution='&copy; <a href="https://www.esri.com/">Esri</a>'
              url="https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"
            />
          </BaseLayer>

          <BaseLayer name="Topografisk (OpenTopoMap)">
            <TileLayer
              attribution='&copy; <a href="https://opentopomap.org">OpenTopoMap</a> contributors'
              url="https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png"
            />
          </BaseLayer>

          <BaseLayer name="M√∏rk modus">
            <TileLayer
              attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
              url="https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png"
            />
          </BaseLayer>

          <BaseLayer name="Norkart (Gratis)">
            <TileLayer
              attribution='&copy; <a href="https://www.norkart.no/">Norkart</a>'
              url="https://waapi.webatlas.no/maptiles/tiles/webatlas-gray-hd/{z}/{x}/{y}.png?api_key=d21625ca-f34d-4d0b-9304-b9b6fc3e2e1b"
            />
          </BaseLayer>

          <BaseLayer name="Kartverket Topografisk">
            <WMSTileLayer
              url="https://wms.geonorge.no/skwms1/wms.topo4"
              layers="topo4_WMS"
              format="image/png"
              attribution="¬© Kartverket"
            />
          </BaseLayer>

          <BaseLayer name="Kartverket Sj√∏kart">
            <WMSTileLayer
              url="https://wms.geonorge.no/skwms1/wms.sjokartraster"
              layers="sjokartraster"
              format="image/png"
              attribution="¬© Kartverket"
            />
          </BaseLayer>

          {/* Overlay lag */}
          <Overlay name="Steder">
            <Marker position={center}>
              <Popup>
                <strong>Kristiansand sentrum</strong><br />
                Velkommen til Kristiansand!
              </Popup>
            </Marker>
          </Overlay>

          {/* Kommunekart og arealbruk lag */}
          <Overlay checked name="Kommunegrenser">
            <WMSTileLayer
              url="https://wms.geonorge.no/skwms1/wms.adm_enheter"
              layers="kommuner"
              format="image/png"
              transparent={true}
              attribution="¬© Kartverket"
              opacity={0.7}
            />
          </Overlay>

          <Overlay checked name="Arealbruk fra AR5">
            <WMSTileLayer
              url="https://wms.nibio.no/cgi-bin/ar5"
              layers="ar5_2022"
              format="image/png"
              transparent={true}
              attribution="¬© NIBIO"
              opacity={0.6}
            />
          </Overlay>

          <Overlay name="Reguleringsplaner">
            <WMSTileLayer
              url="https://wms.geonorge.no/skwms1/wms.plan"
              layers="reguleringsplan_omrade"
              format="image/png"
              transparent={true}
              attribution="¬© Kartverket"
              opacity={0.8}
            />
          </Overlay>

          <Overlay name="Teknisk infrastruktur">
            <WMSTileLayer
              url="https://wms.geonorge.no/skwms1/wms.vegnett"
              layers="riksvegruter,fylkesvegruter,kommunaleveger"
              format="image/png"
              transparent={true}
              attribution="¬© Kartverket"
              opacity={0.7}
            />
          </Overlay>

          <Overlay name="H√∏ydekurver">
            <WMSTileLayer
              url="https://wms.geonorge.no/skwms1/wms.topo4"
              layers="hoydekurver"
              format="image/png"
              transparent={true}
              attribution="¬© Kartverket"
              opacity={0.5}
            />
          </Overlay>

          <Overlay name="Vannkraft og energi">
            <WMSTileLayer
              url="https://wms.geonorge.no/skwms1/wms.energi"
              layers="kraftlinjer,transformatorstasjoner"
              format="image/png"
              transparent={true}
              attribution="¬© Kartverket"
              opacity={0.6}
            />
          </Overlay>
        </LayersControl>
      </MapContainer>
      
      {/* Sidepanel for reguleringsplan */}
      {showSidepanel && (
        <div className="sidepanel">
          <div className="sidepanel-header">
            <h3>Reguleringsplan</h3>
            <button 
              className="close-btn"
              onClick={() => setShowSidepanel(false)}
            >
              √ó
            </button>
          </div>
          
          {selectedLocation && (
            <div className="sidepanel-content">
              <div className="location-info">
                <h4>üìç Adresse</h4>
                <p>{selectedLocation.address}</p>
                
                <div className="detail-item">
                  <strong>Kommune:</strong> {selectedLocation.municipality}
                </div>
                
                <div className="detail-item">
                  <strong>Postnummer:</strong> {selectedLocation.postcode}
                </div>
                
                <div className="detail-item">
                  <strong>Koordinater:</strong> 
                  <br />
                  Lat: {selectedLocation.coordinates.lat.toFixed(6)}
                  <br />
                  Lng: {selectedLocation.coordinates.lng.toFixed(6)}
                </div>
              </div>
              
              <div className="planning-info">
                <h4>üèóÔ∏è Reguleringsplan</h4>
                
                <div className="plan-status">
                  <div className="status-badge active">Gjeldende plan</div>
                  <p>Omr√•det er regulert for blandet form√•l</p>
                </div>
                
                <div className="plan-details">
                  <div className="detail-row">
                    <span>Arealbruk:</span>
                    <span>Bolig/N√¶ring</span>
                  </div>
                  <div className="detail-row">
                    <span>Utnyttingsgrad:</span>
                    <span>BYA 25%, TU 0.8</span>
                  </div>
                  <div className="detail-row">
                    <span>H√∏ydebegrensning:</span>
                    <span>2 etasjer / 8.5m</span>
                  </div>
                  <div className="detail-row">
                    <span>Plan-ID:</span>
                    <span>PL-2023-{Math.floor(Math.random() * 9999)}</span>
                  </div>
                  <div className="detail-row">
                    <span>Vedtaksdato:</span>
                    <span>15.08.2023</span>
                  </div>
                </div>
                
                <div className="pdf-section">
                  <h5>üìÑ Plandokumenter</h5>
                  <p>Her kan du laste ned fullstendig reguleringsplan:</p>
                  
                  <button 
                    className="pdf-btn primary"
                    onClick={() => openPlanDocument('plankart')}
                  >
                    üìã Last ned plankart (PDF)
                  </button>
                  
                  <button 
                    className="pdf-btn secondary"
                    onClick={() => openPlanDocument('bestemmelser')}
                  >
                    üìù Last ned bestemmelser (PDF)
                  </button>
                  
                  <button 
                    className="pdf-btn secondary"
                    onClick={() => openPlanDocument('planbeskrivelse')}
                  >
                    üìä Last ned planbeskrivelse (PDF)
                  </button>
                  
                  <div className="pdf-note">
                    üí° <em>Klikk p√• knappene over for √• √•pne eller laste ned de offisielle plandokumentene for dette omr√•det.</em>
                  </div>
                </div>
                
                <div className="contact-info">
                  <h5>üìû Kontakt</h5>
                  <p>Sp√∏rsm√•l om reguleringsplanen?</p>
                  <div className="contact-details">
                    <div>üìß plan@kristiansand.kommune.no</div>
                    <div>üì± 38 07 50 00</div>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
};

export default MapComponent;
